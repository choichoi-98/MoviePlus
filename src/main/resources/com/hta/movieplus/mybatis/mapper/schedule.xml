<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper	namespace="com.hta.movieplus.mybatis.mapper.SchedulingMapper">
	
	<select id="getScheduleList" parameterType="map" resultType="theaterSchedule">
		SELECT TS.*, M.MOVIE_TITLE
		FROM THEATER_SCHEDULE TS
		JOIN MOVIE M
		ON TS.MOVIE_CODE = M.MOVIE_CODE
		WHERE THEATER_ROOM_ID IN ( SELECT THEATER_ROOM_ID
									FROM THEATER_ROOM
									WHERE THEATER_ID = #{theaterId} )
		AND THEATER_SCHEDULE_DATE = #{todayDate}
		ORDER BY THEATER_SCHEDULE_START
	</select>
	
	<select id="getScheduleListByTheaterRoomId" parameterType="theaterSchedule" resultType="theaterSchedule">
		SELECT *
		FROM THEATER_SCHEDULE
		WHERE THEATER_ROOM_ID = #{THEATER_ROOM_ID}
		AND THEATER_SCHEDULE_DATE = #{THEATER_SCHEDULE_DATE}
		ORDER BY THEATER_SCHEDULE_START 
	</select>
	
	<select id="getOpenMovieList" resultType="movie">
		SELECT *
		FROM MOVIE
		WHERE MOVIE_SCREEN = '상영중'
	</select>
	
	<insert id="addSchedule" parameterType="theaterSchedule">
		INSERT INTO THEATER_SCHEDULE
		VALUES (THEATER_SCHEDULE_SEQ.NEXTVAL, #{THEATER_ID}, #{THEATER_ROOM_ID}, #{THEATER_SCHEDULE_START},
				#{THEATER_SCHEDULE_END}, #{THEATER_SCHEDULE_DATE}, #{MOVIE_CODE}, #{THEATER_SCHEDULE_TYPE})
	</insert>
	
	<select id="getMovieByID" resultType="movie" parameterType="String">
		SELECT * 
		FROM MOVIE
		WHERE MOVIE_CODE = #{MOVIE_CODE}
	</select>
	
	<delete id="deleteScheduleById" parameterType="int">
		DELETE
		FROM THEATER_SCHEDULE
		WHERE THEATER_SCHEDULE_ID = #{theaterId}
	</delete>
	
	<select id="getScheduleById" resultType="theaterSchedule" parameterType="int">
		SELECT TS.*, TR.THEATER_ROOM_NAME, M.MOVIE_TITLE
		FROM THEATER_SCHEDULE TS
		JOIN THEATER_ROOM TR
		ON TS.THEATER_ROOM_ID = TR.THEATER_ROOM_ID
		JOIN MOVIE M
		ON TS.MOVIE_CODE = M.MOVIE_CODE
		WHERE TS.THEATER_SCHEDULE_ID = #{theaterId}
	</select>
	
	<update id ="updateSchedule" parameterType="theaterSchedule">
		UPDATE THEATER_SCHEDULE
		SET MOVIE_CODE = #{MOVIE_CODE}, THEATER_SCHEDULE_TYPE = #{THEATER_SCHEDULE_TYPE}, THEATER_SCHEDULE_START = #{THEATER_SCHEDULE_START}
		WHERE THEATER_SCHEDULE_ID = #{THEATER_SCHEDULE_ID}
	</update>
	
	<select id="getMovieScheduleWithMovie" resultType="theaterSchedule" parameterType="map">
		SELECT *
		FROM THEATER_SCHEDULE TS
		JOIN THEATER T
		ON TS.THEATER_ID = T.THEATER_ID
		JOIN THEATER_ROOM TR
		ON TS.THEATER_ROOM_ID = TR.THEATER_ROOM_ID
		WHERE TS.MOVIE_CODE = #{movieCode}
		AND TS.THEATER_SCHEDULE_DATE = #{date}
		AND T.THEATER_LOCATION = #{location}
	</select>
	
	<select id="getTheaterWithMovie" resultType="theater" parameterType="map">
		SELECT *
		FROM THEATER
		WHERE THEATER_ID IN ( SELECT ID
								FROM
								 ( SELECT TS.THEATER_ID ID, COUNT(*) AS SCHEDULE_COUNT
								FROM THEATER_SCHEDULE TS
								JOIN THEATER T ON TS.THEATER_ID = T.THEATER_ID
								WHERE T.THEATER_LOCATION = #{location}
								  AND TS.MOVIE_CODE = #{movieCode}
								  AND TS.THEATER_SCHEDULE_DATE = #{date}
								GROUP BY TS.THEATER_ID ) 
								 )
		ORDER BY THEATER_CREATED_DATE
	</select>

	<select id="getTheaterRoomWithMovie" resultType="theaterRoom" parameterType="map">
		SELECT *
		FROM THEATER_ROOM
		WHERE THEATER_ROOM_ID IN (SELECT ID
					  FROM (SELECT TR.THEATER_ROOM_ID AS ID, COUNT(*)
							FROM THEATER_SCHEDULE TS
							JOIN THEATER T ON TS.THEATER_ID = T.THEATER_ID
							JOIN THEATER_ROOM TR ON TS.THEATER_ROOM_ID = TR.THEATER_ROOM_ID
							WHERE T.THEATER_LOCATION = #{location}
							AND TS.MOVIE_CODE = #{movieCode}
							AND TS.THEATER_SCHEDULE_DATE = #{date}
							GROUP BY TR.THEATER_ROOM_ID
							)
						)
		ORDER BY THEATER_ROOM_ID

	</select>
	
	<select id="getMovieWithTheater" resultType="movie" parameterType="map">
		SELECT *
		FROM MOVIE
		WHERE MOVIE_CODE IN ( SELECT ID
					FROM ( SELECT MOVIE_CODE ID, COUNT(*)
						FROM THEATER_SCHEDULE
						WHERE THEATER_ID = #{theaterId}
						AND THEATER_SCHEDULE_DATE = #{date}
						GROUP BY MOVIE_CODE )
					)		
	</select>
	
	<select id="getTheaterRoomWithTheater" resultType="theaterRoom" parameterType="map">
		SELECT *
		FROM THEATER_ROOM
		WHERE THEATER_ROOM_ID IN ( SELECT ID
					   FROM ( SELECT THEATER_ROOM_ID ID, COUNT(*)
						FROM THEATER_SCHEDULE
						WHERE THEATER_ID = #{theaterId}
						AND THEATER_SCHEDULE_DATE = #{date}
						GROUP BY THEATER_ROOM_ID )
					)
		ORDER BY THEATER_ROOM_ID
		
		
	</select>
	
	<select id="getScheduleWithTheater" resultType="theaterSchedule" parameterType="map">
		SELECT *
		FROM THEATER_SCHEDULE
		WHERE THEATER_ID = #{theaterId}
		AND THEATER_SCHEDULE_DATE = #{date}
		ORDER BY THEATER_ROOM_ID, THEATER_SCHEDULE_START
	</select>
		
</mapper>