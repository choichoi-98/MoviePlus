<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper	namespace="com.hta.movieplus.mybatis.mapper.MoviePostMapper">
	
	<!-- 임시, 예매 기능 완료되면 수정 -->
	<select id="getSeenMovieList" parameterType="int" resultType="movie">
		SELECT * 
		FROM MOVIE
	</select>
	
	<select id="getMovieByCode" parameterType="String" resultType="movie">
		SELECT *
		FROM MOVIE
		WHERE MOVIE_CODE = #{movieCode}
	</select>
	
	<insert id="insert" parameterType="moviePostVO">
		INSERT INTO MOVIEPOST
		VALUES ( MOVIEPOST_SEQ.NEXTVAL, #{movie_Code}, #{member_Id}, #{moviepost_Still}, #{moviepost_Content}, to_char(sysdate,'yyyy-mm-dd'), #{moviepost_Like} )
	</insert>
	
	<select id="getMoviePostList" parameterType="map" resultType="moviePostVO">
		
		SELECT ROWNUM, T.*
		FROM (
		    SELECT *
		    FROM MOVIEPOST MP
		    JOIN MOVIE M ON MP.MOVIE_CODE = M.MOVIE_CODE
		    WHERE M.MOVIE_TITLE LIKE  '%' ||  #{keyword} || '%'
		<choose>
			<when test='option == "date"'>
			ORDER BY MP.MOVIEPOST_NUM desc
			</when>
			<when test='option == "like"'>
			ORDER BY MP.MOVIEPOST_LIKE DESC
			</when>	
		</choose>
		) T
		WHERE ROWNUM &lt;= #{index}
		
	</select>
	
	<select id="getPostDetail" parameterType="int" resultType="moviePostVO">
		SELECT *
		FROM MOVIEPOST MP
		JOIN MOVIE M ON MP.MOVIE_CODE = M.MOVIE_CODE
		JOIN MEMBER MEM ON MP.MEMBER_ID = MEM.MEMBER_ID 
		WHERE MP.MOVIEPOST_NUM = #{postNum}
	</select>
	
	<select id="getMovieWithPostCnt" resultType="movie">
		SELECT M.*, NVL(MP.CNT, 0) post_Count
		FROM MOVIE M
		LEFT JOIN ( SELECT MOVIE_CODE, COUNT(*) CNT
		FROM MOVIEPOST
		GROUP BY MOVIE_CODE) MP
		ON M.MOVIE_CODE = MP.MOVIE_CODE
		ORDER BY CNT
	</select>
	
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*)
		FROM MOVIEPOST
	</select>
	
	<select id="getMyPostCnt" resultType="int" parameterType="String">
		SELECT COUNT(*)
		FROM MOVIEPOST
		WHERE MEMBER_ID = #{MEMBER_ID}
	</select>
	
	
</mapper>